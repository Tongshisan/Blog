# 离线包



**离线包** 是将 `html`, `js`, `css` 等页面内静态资源打包到一个压缩包内. 预先下载离线包到本地, 然后通过客户端打开, 直接从本地加载离线包, 从而最大程度摆脱网络环境对 H5 页面的影响.

优势:

+ **提升用户体验**: 通过离线包的方式把页面内静态资源嵌入到应用中并发布, 当用户第一次开启应用的时候, 就无需依赖网络环境下载该资源, 而是马上开始使用该应用.
+ **实现动态更新**: 在退出新版本或紧急发布的时候, 可以把修改的资源放入离线包, 通过更新配置让应用自动下载更新. 无需通过应用商店审核通过, 就能让用户及早接收更新.



##  react-dev-utils/InlineChunkHtmlPlugin

React 官方在 CRA 脚手架中提供了这种方式，去将指定的 chunk 内联到 html。

这种方式对 `js` 很好用, 但是对 `css` 不好使, 这里使用一下插件内联 `css`:

```
html-inline-css-webpack-plugin
```

使用方式:

```js
const HtmlWebpackPlugin = require('html-webpack-plugin');
const InlineChunkHtmlPlugin = require('react-dev-utils/InlineChunkHtmlPlugin');
const HtmlInlineCssWebpackPlugin = require('html-inline-css-webpack-plugin').default;

module.exports = {
  ...
  plugins: [
    new HtmlWebpackPlugin(),
    new InlineChunkHtmlPlugin(HtmlWebpackPlugin, [/runtime~.+[.]js/]),
    new HtmlInlineCssWebpackPlugin(),
    ...
  ],
  ...
}
```

遇到的坑:

配置完成后每次打包都有几个 `chunk.js` 文件没打进去 :sob:, 跌跌撞撞才发现是路由动态加载的原因:

```js
export const routers = [
  {
    path: '/',
    component: loadable(() => import('../pages/Index')),
  },
  {
    path: '/test',
    component: loadable(() => import('../pages/Test'))
  }
]
```

修改为:

```js
import loadable from '@loadable/component';
import Index from '../page/Index';
import Test from '../page/Test';

export const routers = [
  {
    path: '/',
    component: Index
  },
  {
    path: '/test',
    component: Test
  }
]
```

然后想根据是不是打离线包来区分路由是否懒加载:

```js
import loadable from '@loadable/component';

let Index = null;
let Test = null;
if (process.env.REACT_APP_INLINE === 'true') {
  
  // 动态引入使用 require, 并且后面要加 .default
  Index = require('../page/Index').default;
  Test = require('../page/Test').default;
} else {
  Index = loadable(() => import('../pages/Index'));
  Test = loadable(() => import('../pages/Test'));
}

export const routers = [
  {
    path: '/',
    component: Index
  },
  {
    path: '/test',
    component: Test
  }
]
```



## inline-source-webpack-plugin

[友情链接](https://www.npmjs.com/package/inline-source-webpack-plugin)

```shell
npm i --save-dev inline-source-webpack-plugin
```

修改 `index.html`

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>test</title>
    <link href="inline.css" inline="true">
    <script src="inline.js" inline="true"></script> 
  </head>
  <body>
    <div class="container">
      <h1>hello world!</h1>
    </div>
    <!-- 'inline-asset' attribute tell us to embed file that generated by webpack -->
    <script inline inline-asset="runtime\.\w+\.js$" inline-asset-delete></script> 
    <script inline inline-asset="bundle\.\w+\.js$" inline-asset-delete></script> 
  </body>
</html>
```

`webpack.config.js`

```js
const HtmlWebpackPlugin = require('html-webpack-plugin');
const InlineSourceWebpackPlugin = require('inline-source-webpack-plugin');

module.exports = {
  ...,
  plugins: [
    new HtmlWebpackPlugin({
      ...
    }),
    new InlineSourceWebpackPlugin({
      compress: true,
      rootpath: './src',
      noAssetMatch: 'warn'
    })
  ]
};
```





## html-webpack-inline-source-plugin

[友情链接](https://www.npmjs.com/package/html-webpack-inline-source-plugin)

```shell
npm install --save-dev html-webpack-inline-source-plugin
```

`webpack.config.js`

```js
const HtmlWebpackPlugin = require('html-webpack-plugin');
const HtmlWebpackInlineSourcePlugin = require('html-webpack-inline-source-plugin');

module.exports = {
  ...
  plugins: [
    new HtmlWebpackPlugin({
      ...,
      inlineSource: '.(js|css)$',
    }),
    new HtmlWebpackInlineSourcePlugin()
  ],
  ...
}
```







*[内联 js, css](https://webpack.eleven.net.cn/content/inline.html#react-dev-utilsinlinechunkhtmlplugin)*

[内联 js, css, 没有 html-webpack-inline-source-plugin](https://www.coder.work/article/7153168)

